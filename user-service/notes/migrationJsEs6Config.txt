// Converted to ESNext (using async/await, import/export, and modern Node.js syntax)
import fs from "fs/promises"; // Use promises-based fs
import path from "path";
import { fileURLToPath } from "url";

// Define __dirname and __filename for ESM compatibility
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Global variables (kept as-is for db-migrate compatibility)
let dbm;
let type;
let seed;
let Promise;

// Setup function (runs once when db-migrate loads the migration)
export const setup = (options, seedLink) => {
  dbm = options.dbmigrate;
  type = dbm.dataType;
  seed = seedLink;
  Promise = options.Promise;
};

// Helper to read SQL file asynchronously
const readSqlFile = async (filePath) => {
  const data = await fs.readFile(filePath, { encoding: "utf-8" });
  console.log("received data: " + data);
  return data;
};

// Up migration (applies the changes)
export const up = async (db) => {
  const filePath = path.join(
    __dirname,
    "sqls",
    "20251221120338-cart-n-cart-items-up.sql"
  );
  const sql = await readSqlFile(filePath);
  return db.runSql(sql);
};

// Down migration (rolls back the changes)
export const down = async (db) => {
  const filePath = path.join(
    __dirname,
    "sqls",
    "20251221120338-cart-n-cart-items-down.sql"
  );
  const sql = await readSqlFile(filePath);
  return db.runSql(sql);
};

// Metadata (required by db-migrate)
export const _meta = {
  version: 1,
};
